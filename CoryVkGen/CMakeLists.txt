find_package(Python REQUIRED COMPONENTS Interpreter)

find_package(Vulkan REQUIRED)

# the vk.xml discovery is pretty primitive and assumes the folder structure
# I'm seeing for the Windows SDK - wouldn't be surprised if this fails..
set(VULKAN_REGISTRY_XML ${Vulkan_INCLUDE_DIR}/../share/vulkan/registry/vk.xml)
if (EXISTS ${VULKAN_REGISTRY_XML})
    message(STATUS "Using Vulkan registry at ${VULKAN_REGISTRY_XML}")
else ()
    message(NOTICE "Unsuccessfully tried to find vk.xml at '${VULKAN_REGISTRY_XML}'.")
    message(FATAL_ERROR "Could not discover vk.xml. Please fix me.")
endif ()

set(CVK_DIR ${CMAKE_CURRENT_LIST_DIR}/cvk)

set(PYTHON_SOURCES
        __main__.py
        cvkg/__init__.py
        cvkg/flextglutils.py
        cvkg/BuilderGenerator.py
        cvkg/EnumFmtGenerator.py
        cvkg/Generator.py
        cvkg/GeneratorBase.py
        cvkg/GeneratorUtils.py
        cvkg/SpecParser.py
        cvkg/StructFmtGenerator.py
        cvkg/Types.py
        )
set(TEMPLATE_SOURCES
        templates/Builder.tpl.h
        templates/FmtEnum.tpl.h
        templates/FmtStruct.tpl.h
        )

message("Running CoryVkGen to generate autogenerated files")
execute_process(
        COMMAND ${Python_EXECUTABLE} ${CMAKE_CURRENT_LIST_DIR}/__main__.py --output_folder ${CVK_DIR} --registry ${VULKAN_REGISTRY_XML}
        WORKING_DIRECTORY ${CMAKE_CURRENT_LIST_DIR}
        COMMAND_ERROR_IS_FATAL ANY
)

include(cvk/GeneratedFiles.cmake)

# these were defined relative to the parent directory
set(RELATIVE_GENERATED_FILES ${CVK_GENERATED_FILES})
list(TRANSFORM RELATIVE_GENERATED_FILES PREPEND "cvk/")

# custom command to automatically re-run CoryVkGen if any relevant files have been modified
message("Generated Files: " ${RELATIVE_GENERATED_FILES})
add_custom_command(
        OUTPUT ${RELATIVE_GENERATED_FILES}
        COMMAND ${Python_EXECUTABLE} ${CMAKE_CURRENT_LIST_DIR}/__main__.py --output_folder ${CMAKE_CURRENT_LIST_DIR} --registry ${VULKAN_REGISTRY_XML}
        WORKING_DIRECTORY ${CMAKE_CURRENT_LIST_DIR}/..
        DEPENDS ${PYTHON_SOURCES} ${TEMPLATE_SOURCES}
        COMMENT "Re-generating autogenerated files..."
)


add_subdirectory(cvk)

